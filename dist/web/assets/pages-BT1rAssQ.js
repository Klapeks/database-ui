import{r as d,j as s}from"./react-DuErVCKP.js";import{a as C}from"./axios-DW_MHI2K.js";const N={encodeJSON(t,n){return N.encode(JSON.stringify(t),n)},decodeJSON(t,n){return JSON.parse(N.decode(t,n))},encode(t,n){let a=new Uint16Array(t.length);for(let e=0;e<a.length;e++)a[e]=t.charCodeAt(e);a=new Uint8Array(a.buffer);let i="",r=0;for(let e=0;e<a.length;e++)r=(a[e]^n.charCodeAt(e%n.length))&255,i+=String.fromCharCode(r);return btoa(i)},decode(t,n){t=atob(t);let a=new Uint8Array(t.length);for(let r=0;r<a.length;r++)a[r]=(t.charCodeAt(r)^n.charCodeAt(r%n.length))&255;a=new Uint16Array(a.buffer);let i="";for(let r=0;r<a.length;r++)i+=String.fromCharCode(a[r]);return i}};C.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let y;async function O(){return y=(await C.get("/api/database-ui/api/database-type")).data,y.type}async function j(t,n){if(!y)throw"No db info";t=N.encode(t,y.key);const a=await C.post("/api/database-ui/api/sql",{sql:t,params:n});return N.decodeJSON(a.data.data,y.key)}const A=d.createContext(null),$=({children:t})=>{const[n,a]=d.useState(),[i,r]=d.useState([]),[e,c]=d.useState(),[T,l]=d.useState(),[m,b]=d.useState(),o=async()=>{const f=await O();a(f);let u=await j("SHOW DATABASES");u=u.map(x=>x.Database||x),r(u)},p=async f=>{b(void 0),c(f);let u=await j(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${f}';
        `);u=u.map(x=>{var E;return x.TABLE_NAME||((E=Object.values(x))==null?void 0:E[0])||x}),l(u)},h=async f=>{b(f)};return s.jsx(A.Provider,{value:{databaseType:n,databasesList:i,loadDatabaseInfo:o,selectedDatabase:e,selectDatabase:p,selectedDatabaseTables:T,selectedTable:m,selectTable:h},children:t})},S=()=>{const t=d.useContext(A);if(!t)throw new Error("useDatabase must be used within a DatabaseProvider");return t},D=()=>{const{databaseType:t,databasesList:n,selectedDatabase:a,selectDatabase:i,selectedDatabaseTables:r,selectTable:e}=S();return s.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[s.jsxs("p",{children:["Database type: ",t]}),s.jsx("br",{}),n.map(c=>s.jsx("button",{className:"button flex-start",title:c,onClick:()=>i(c),children:s.jsx("p",{children:c})},c)),s.jsx("hr",{style:{margin:"15px 0"}}),a&&s.jsx("p",{children:"Tables:"}),r==null?void 0:r.map(c=>s.jsx("button",{className:"button flex-start",title:c,onClick:()=>e(c),children:s.jsx("p",{children:c})},c))]})},L={"table-viewer":"_table-viewer_wdq6x_1"},v="_pagination_1jqa4_1",_={pagination:v};function M(t,n,a){const i=Math.floor(a/2),r=[];if(n<=a){for(let e=1;e<=n;e++)r.push(e);return r}if(t-i<=0)for(let e=1;e<=a;e++)r.push(e);else if(t-i+a>n)for(let e=0;e<a;e++)r.unshift(n-e);else for(let e=0;e<a;e++)r.push(t+e-i);return r.unshift("first","-1"),r.push("+1","max"),r}const U=({page:t,maxPages:n,setPage:a})=>{const i=M(t,n,10),r=e=>{e==="+1"&&(e=t+1),e==="-1"&&(e=t-1),!(typeof e=="number"&&(e<=0||e>n))&&(e==="max"&&(e=n),e==="first"&&(e=1),a(e))};return s.jsx("div",{className:_.pagination,children:i.map(e=>s.jsx("div",{className:t===e?"active":"",onClick:()=>r(e),children:s.jsx("p",{children:e==="+1"?">":e==="-1"?"<":e==="max"?n:e==="first"?1:e})},e))})};function g(t,n){return[...t].filter(i=>i.COLUMN_KEY=="PRI").map(i=>i.COLUMN_NAME).map(i=>n[i]).join("-")}const w=({database:t,table:n})=>{const[a,i]=d.useState(),[r,e]=d.useState(),[c,T]=d.useState(0),[l,m]=d.useState({page:1,limit:100,orderBy:void 0,orderType:"ASC"});d.useEffect(()=>{t&&n&&j(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${t}' 
                AND table_name = '${n}'
            `).then(o=>{o=o.sort((p,h)=>p.ORDINAL_POSITION-h.ORDINAL_POSITION),i(o),j(`
                    SELECT COUNT(1) as count 
                    FROM \`${t}\`.\`${n}\`
                `).then(p=>{var h;T(((h=p[0])==null?void 0:h.count)??p[0]??p)})})},[t,n]),d.useEffect(()=>{a&&j(`
            SELECT ${a.map(o=>"`"+o.COLUMN_NAME+"`").join(", ")}
            FROM \`${t}\`.\`${n}\`
            ${l.orderBy?"ORDER BY "+l.orderBy+" "+l.orderType:""}
            LIMIT ${l.limit} OFFSET ${(l.page-1)*l.limit};
        `).then(o=>{e(o)})},[a,l]);const b=o=>{l.orderBy==o?l.orderType=="ASC"?(l.orderType="DESC",l.orderBy=void 0):l.orderType=="DESC"&&(l.orderType="ASC"):(l.orderBy=o,l.orderType="DESC"),m({...l})};return!t||!n||!a?null:s.jsxs("div",{className:"component pad-15",style:{overflow:"auto"},children:[s.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between"},children:[s.jsxs("p",{children:["Total: ",(r==null?void 0:r.length)??"-"," of ",c]}),s.jsx(U,{page:l.page,setPage:o=>m({...l,page:o}),maxPages:Math.ceil(c/l.limit)})]}),s.jsxs("table",{className:L["table-viewer"],children:[s.jsx("thead",{children:s.jsxs("tr",{children:[s.jsx("th",{}),a.map(o=>s.jsxs("th",{className:"column-name",children:[s.jsxs("p",{children:[o.COLUMN_NAME," ",o.COLUMN_KEY=="PRI"?s.jsx("span",{style:{fontSize:"12px"},children:"🔑"}):null]}),s.jsxs("p",{className:"type",children:[o.COLUMN_TYPE,o.IS_NULLABLE&&o.IS_NULLABLE!="NO"?"?":""]}),s.jsx("button",{className:"button sort",onClick:()=>b(o.COLUMN_NAME),children:l.orderBy==o.COLUMN_NAME?l.orderType=="DESC"?s.jsx("p",{children:"🔽"}):s.jsx("p",{children:"🔼"}):s.jsx("p",{children:"↕️"})})]},o.COLUMN_NAME))]})}),s.jsx("tbody",{children:r==null?void 0:r.map(o=>{const p=t+"-"+n+"-"+g(a,o);return s.jsxs("tr",{children:[s.jsx("td",{className:"edit-pen",children:"✏️"}),Object.keys(o).map(h=>s.jsx("td",{children:s.jsx("p",{className:[o[h]===null&&"null"].filter(Boolean).join(" "),children:o[h]??"NULL"})},p+"-"+h))]},p)})})]})]})},I=()=>{const{databaseType:t,selectedDatabase:n,selectedTable:a}=S();return s.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[s.jsx("div",{className:"component pad-15",children:n?a?s.jsxs("p",{children:[t," / ",n," / ",a]}):s.jsxs("p",{children:[t," / ",n]}):s.jsx("p",{children:t})}),s.jsx(w,{database:n,table:a},n+"-"+a)]})};function k(){const{databaseType:t,loadDatabaseInfo:n}=S();return d.useEffect(()=>{n()},[]),t?s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[s.jsx(D,{}),s.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:s.jsx(I,{})})]}):s.jsx("div",{children:s.jsx("p",{children:"Loading..."})})}export{k as A,$ as D};
