import{r as c,j as s}from"./react-DuErVCKP.js";import{a as T}from"./axios-DW_MHI2K.js";const j={encodeJSON(e,t){return j.encode(JSON.stringify(e),t)},decodeJSON(e,t){return JSON.parse(j.decode(e,t))},encode(e,t){let a="",r=0;for(let n=0;n<e.length;n++)r=(e.charCodeAt(n)^t.charCodeAt(n%t.length))&255,a+=String.fromCharCode(r);return btoa(a)},decode(e,t){e=atob(e);let a="",r=0;for(let n=0;n<e.length;n++)r=(e.charCodeAt(n)^t.charCodeAt(n%t.length))&255,a+=String.fromCharCode(r);return a}};T.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let b;async function O(){return b=(await T.get("/api/database-ui/api/database-type")).data,b.type}async function f(e,t){if(!b)throw"No db info";e=j.encode(e,b.key);const a=await T.post("/api/database-ui/api/sql",{sql:e,params:t});return j.decodeJSON(a.data.data,b.key)}const N=c.createContext(null),_=({children:e})=>{const[t,a]=c.useState(),[r,n]=c.useState([]),[m,i]=c.useState(),[y,u]=c.useState(),[C,o]=c.useState(),l=async()=>{const h=await O();a(h);let p=await f("SHOW DATABASES");p=p.map(x=>x.Database||x),n(p)},d=async h=>{o(void 0),i(h);let p=await f(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${h}';
        `);p=p.map(x=>{var E;return x.TABLE_NAME||((E=Object.values(x))==null?void 0:E[0])||x}),u(p)},D=async h=>{o(h)};return s.jsx(N.Provider,{value:{databaseType:t,databasesList:r,loadDatabaseInfo:l,selectedDatabase:m,selectDatabase:d,selectedDatabaseTables:y,selectedTable:C,selectTable:D},children:e})},S=()=>{const e=c.useContext(N);if(!e)throw new Error("useDatabase must be used within a DatabaseProvider");return e},A=()=>{const{databaseType:e,databasesList:t,selectedDatabase:a,selectDatabase:r,selectedDatabaseTables:n,selectTable:m}=S();return s.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[s.jsxs("p",{children:["Database type: ",e]}),s.jsx("br",{}),t.map(i=>s.jsx("button",{className:"button flex-start",title:i,onClick:()=>r(i),children:s.jsx("p",{children:i})},i)),s.jsx("hr",{style:{margin:"15px 0"}}),a&&s.jsx("p",{children:"Tables:"}),n==null?void 0:n.map(i=>s.jsx("button",{className:"button flex-start",title:i,onClick:()=>m(i),children:s.jsx("p",{children:i})},i))]})};function v(e,t){return[...e].filter(r=>r.COLUMN_KEY=="PRI").map(r=>r.COLUMN_NAME).map(r=>t[r]).join("-")}const L=({database:e,table:t})=>{const[a,r]=c.useState(),[n,m]=c.useState(),[i,y]=c.useState(0),[u,C]=c.useState({orderBy:void 0,orderType:"ASC"});return c.useEffect(()=>{e&&t&&f(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${e}' 
                AND table_name = '${t}'
            `).then(o=>{o=o.sort((l,d)=>l.ORDINAL_POSITION-d.ORDINAL_POSITION),r(o),f(`
                    SELECT COUNT(1) as count 
                    FROM \`${e}\`.\`${t}\`
                `).then(l=>{var d;y(((d=l[0])==null?void 0:d.count)||l[0]||l)})})},[e,t]),c.useEffect(()=>{a&&f(`
            SELECT ${a.map(o=>"`"+o.COLUMN_NAME+"`").join(", ")}
            FROM \`${e}\`.\`${t}\`
            ${u.orderBy?"ORDER BY "+u.orderBy+" "+u.orderType:""}
            LIMIT 500;
        `).then(o=>{m(o)})},[a,u]),!e||!t||!a?null:s.jsx("div",{className:"component pad-15",style:{overflow:"auto"},children:s.jsxs("table",{className:"test-table",children:[s.jsx("thead",{children:s.jsx("tr",{children:a.map(o=>s.jsx("th",{children:o.COLUMN_NAME},o.COLUMN_NAME))})}),s.jsx("tbody",{children:n==null?void 0:n.map(o=>{const l=e+"-"+t+"-"+v(a,o);return s.jsx("tr",{children:Object.keys(o).map(d=>s.jsx("td",{children:s.jsx("p",{className:[o[d]===null&&"null"].filter(Boolean).join(" "),children:o[d]??"NULL"})},l+"-"+d))},l)})})]})})},w=()=>{const{databaseType:e,selectedDatabase:t,selectedTable:a}=S();return s.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[s.jsx("div",{className:"component pad-15",children:t?a?s.jsxs("p",{children:[e," / ",t," / ",a]}):s.jsxs("p",{children:[e," / ",t]}):s.jsx("p",{children:e})}),s.jsx(L,{database:t,table:a},t+"-"+a)]})};function R(){const{databaseType:e,loadDatabaseInfo:t}=S();return c.useEffect(()=>{t()},[]),e?s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[s.jsx(A,{}),s.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:s.jsx(w,{})})]}):s.jsx("div",{children:s.jsx("p",{children:"Loading..."})})}export{R as A,_ as D};
