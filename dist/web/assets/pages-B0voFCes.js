import{r as c,j as e}from"./react-DuErVCKP.js";import{a as C}from"./axios-DW_MHI2K.js";const j={encodeJSON(t,s){return j.encode(JSON.stringify(t),s)},decodeJSON(t,s){return JSON.parse(j.decode(t,s))},encode(t,s){let a=new Uint16Array(t.length);for(let i=0;i<a.length;i++)a[i]=t.charCodeAt(i);a=new Uint8Array(a.buffer);let o="",r=0;for(let i=0;i<a.length;i++)r=(a[i]^s.charCodeAt(i%s.length))&255,o+=String.fromCharCode(r);return btoa(o)},decode(t,s){t=atob(t);let a=new Uint8Array(t.length);for(let r=0;r<a.length;r++)a[r]=(t.charCodeAt(r)^s.charCodeAt(r%s.length))&255;a=new Uint16Array(a.buffer);let o="";for(let r=0;r<a.length;r++)o+=String.fromCharCode(a[r]);return o}};C.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let m;async function O(){return m=(await C.get("/api/database-ui/api/database-type")).data,m.type}async function f(t,s){if(!m)throw"No db info";t=j.encode(t,m.key);const a=await C.post("/api/database-ui/api/sql",{sql:t,params:s});return j.decodeJSON(a.data.data,m.key)}const A=c.createContext(null),U=({children:t})=>{const[s,a]=c.useState(),[o,r]=c.useState([]),[i,d]=c.useState(),[N,l]=c.useState(),[T,b]=c.useState(),n=async()=>{const x=await O();a(x);let u=await f("SHOW DATABASES");u=u.map(y=>y.Database||y),r(u)},p=async x=>{b(void 0),d(x);let u=await f(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${x}';
        `);u=u.map(y=>{var E;return y.TABLE_NAME||((E=Object.values(y))==null?void 0:E[0])||y}),l(u)},h=async x=>{b(x)};return e.jsx(A.Provider,{value:{databaseType:s,databasesList:o,loadDatabaseInfo:n,selectedDatabase:i,selectDatabase:p,selectedDatabaseTables:N,selectedTable:T,selectTable:h},children:t})},S=()=>{const t=c.useContext(A);if(!t)throw new Error("useDatabase must be used within a DatabaseProvider");return t},D=()=>{const{databaseType:t,databasesList:s,selectedDatabase:a,selectDatabase:o,selectedDatabaseTables:r,selectTable:i}=S();return e.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[e.jsxs("p",{children:["Database type: ",t]}),e.jsx("br",{}),s.map(d=>e.jsx("button",{className:"button flex-start",title:d,onClick:()=>o(d),children:e.jsx("p",{children:d})},d)),e.jsx("hr",{style:{margin:"15px 0"}}),a&&e.jsx("p",{children:"Tables:"}),r==null?void 0:r.map(d=>e.jsx("button",{className:"button flex-start",title:d,onClick:()=>i(d),children:e.jsx("p",{children:d})},d))]})},L={"table-viewer":"_table-viewer_wdq6x_1"};function w(t,s){return[...t].filter(o=>o.COLUMN_KEY=="PRI").map(o=>o.COLUMN_NAME).map(o=>s[o]).join("-")}const g=({database:t,table:s})=>{const[a,o]=c.useState(),[r,i]=c.useState(),[d,N]=c.useState(0),[l,T]=c.useState({orderBy:void 0,orderType:"ASC"});c.useEffect(()=>{t&&s&&f(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${t}' 
                AND table_name = '${s}'
            `).then(n=>{n=n.sort((p,h)=>p.ORDINAL_POSITION-h.ORDINAL_POSITION),o(n),f(`
                    SELECT COUNT(1) as count 
                    FROM \`${t}\`.\`${s}\`
                `).then(p=>{var h;N(((h=p[0])==null?void 0:h.count)??p[0]??p)})})},[t,s]),c.useEffect(()=>{a&&f(`
            SELECT ${a.map(n=>"`"+n.COLUMN_NAME+"`").join(", ")}
            FROM \`${t}\`.\`${s}\`
            ${l.orderBy?"ORDER BY "+l.orderBy+" "+l.orderType:""}
            LIMIT 500;
        `).then(n=>{i(n)})},[a,l]);const b=n=>{l.orderBy==n?l.orderType=="ASC"?(l.orderType="DESC",l.orderBy=void 0):l.orderType=="DESC"&&(l.orderType="ASC"):(l.orderBy=n,l.orderType="DESC"),T({...l})};return!t||!s||!a?null:e.jsxs("div",{className:"component pad-15",style:{overflow:"auto"},children:[e.jsxs("p",{children:["Total: ",(r==null?void 0:r.length)??"-"," of ",d]}),e.jsxs("table",{className:L["table-viewer"],children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{}),a.map(n=>e.jsxs("th",{className:"column-name",children:[e.jsxs("p",{children:[n.COLUMN_NAME," ",n.COLUMN_KEY=="PRI"?e.jsx("span",{style:{fontSize:"12px"},children:"🔑"}):null]}),e.jsxs("p",{className:"type",children:[n.COLUMN_TYPE,n.IS_NULLABLE&&n.IS_NULLABLE!="NO"?"?":""]}),e.jsx("button",{className:"button sort",onClick:()=>b(n.COLUMN_NAME),children:l.orderBy==n.COLUMN_NAME?l.orderType=="DESC"?e.jsx("p",{children:"🔽"}):e.jsx("p",{children:"🔼"}):e.jsx("p",{children:"↕️"})})]},n.COLUMN_NAME))]})}),e.jsx("tbody",{children:r==null?void 0:r.map(n=>{const p=t+"-"+s+"-"+w(a,n);return e.jsxs("tr",{children:[e.jsx("td",{className:"edit-pen",children:"✏️"}),Object.keys(n).map(h=>e.jsx("td",{children:e.jsx("p",{className:[n[h]===null&&"null"].filter(Boolean).join(" "),children:n[h]??"NULL"})},p+"-"+h))]},p)})})]})]})},v=()=>{const{databaseType:t,selectedDatabase:s,selectedTable:a}=S();return e.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[e.jsx("div",{className:"component pad-15",children:s?a?e.jsxs("p",{children:[t," / ",s," / ",a]}):e.jsxs("p",{children:[t," / ",s]}):e.jsx("p",{children:t})}),e.jsx(g,{database:s,table:a},s+"-"+a)]})};function I(){const{databaseType:t,loadDatabaseInfo:s}=S();return c.useEffect(()=>{s()},[]),t?e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[e.jsx(D,{}),e.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:e.jsx(v,{})})]}):e.jsx("div",{children:e.jsx("p",{children:"Loading..."})})}export{I as A,U as D};
