import{r,j as s}from"./react-DuErVCKP.js";import{a as T}from"./axios-DW_MHI2K.js";const y={encodeJSON(e,t){return y.encode(JSON.stringify(e),t)},decodeJSON(e,t){return JSON.parse(y.decode(e,t))},encode(e,t){let a=Array(e.length);for(let n=0;n<e.length;n++)a[n]=(e.charCodeAt(n)^t.charCodeAt(n%t.length))&255;return btoa(String.fromCharCode(...a))},decode(e,t){e=atob(e);let a=Array(e.length);for(let n=0;n<e.length;n++)a[n]=(e.charCodeAt(n)^t.charCodeAt(n%t.length))&255;return String.fromCharCode(...a)}};T.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let f;async function A(){return f=(await T.get("/api/database-ui/api/database-type")).data,f.type}async function b(e,t){if(!f)throw"No db info";const a=await T.post("/api/database-ui/api/sql",{sql:e,params:t});return y.decodeJSON(a.data.data,f.key)}const N=r.createContext(null),_=({children:e})=>{const[t,a]=r.useState(),[n,d]=r.useState([]),[m,c]=r.useState(),[j,h]=r.useState(),[C,o]=r.useState(),l=async()=>{const u=await A();a(u);let p=await b("SHOW DATABASES");p=p.map(x=>x.Database||x),d(p)},i=async u=>{o(void 0),c(u);let p=await b(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${u}';
        `);p=p.map(x=>{var E;return x.TABLE_NAME||((E=Object.values(x))==null?void 0:E[0])||x}),h(p)},D=async u=>{o(u)};return s.jsx(N.Provider,{value:{databaseType:t,databasesList:n,loadDatabaseInfo:l,selectedDatabase:m,selectDatabase:i,selectedDatabaseTables:j,selectedTable:C,selectTable:D},children:e})},S=()=>{const e=r.useContext(N);if(!e)throw new Error("useDatabase must be used within a DatabaseProvider");return e},O=()=>{const{databaseType:e,databasesList:t,selectedDatabase:a,selectDatabase:n,selectedDatabaseTables:d,selectTable:m}=S();return s.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[s.jsxs("p",{children:["Database type: ",e]}),s.jsx("br",{}),t.map(c=>s.jsx("button",{className:"button flex-start",title:c,onClick:()=>n(c),children:s.jsx("p",{children:c})},c)),s.jsx("hr",{style:{margin:"15px 0"}}),a&&s.jsx("p",{children:"Tables:"}),d==null?void 0:d.map(c=>s.jsx("button",{className:"button flex-start",title:c,onClick:()=>m(c),children:s.jsx("p",{children:c})},c))]})};function v(e,t){return[...e].filter(n=>n.COLUMN_KEY=="PRI").map(n=>n.COLUMN_NAME).map(n=>t[n]).join("-")}const L=({database:e,table:t})=>{const[a,n]=r.useState(),[d,m]=r.useState(),[c,j]=r.useState(0),[h,C]=r.useState({orderBy:void 0,orderType:"ASC"});return r.useEffect(()=>{e&&t&&b(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${e}' 
                AND table_name = '${t}'
            `).then(o=>{o=o.sort((l,i)=>l.ORDINAL_POSITION-i.ORDINAL_POSITION),n(o),b(`
                    SELECT COUNT(1) as count 
                    FROM \`${e}\`.\`${t}\`
                `).then(l=>{var i;j(((i=l[0])==null?void 0:i.count)||l[0]||l)})})},[e,t]),r.useEffect(()=>{a&&b(`
            SELECT ${a.map(o=>"`"+o.COLUMN_NAME+"`").join(", ")}
            FROM \`${e}\`.\`${t}\`
            ${h.orderBy?"ORDER BY "+h.orderBy+" "+h.orderType:""}
            LIMIT 500;
        `).then(o=>{m(o)})},[a,h]),!e||!t||!a?null:s.jsx("div",{className:"component pad-15",style:{overflow:"auto"},children:s.jsxs("table",{className:"test-table",children:[s.jsx("thead",{children:s.jsx("tr",{children:a.map(o=>s.jsx("th",{children:o.COLUMN_NAME},o.COLUMN_NAME))})}),s.jsx("tbody",{children:d==null?void 0:d.map(o=>{const l=e+"-"+t+"-"+v(a,o);return s.jsx("tr",{children:Object.keys(o).map(i=>s.jsx("td",{children:s.jsx("p",{className:[o[i]===null&&"null"].filter(Boolean).join(" "),children:o[i]??"NULL"})},l+"-"+i))},l)})})]})})},g=()=>{const{databaseType:e,selectedDatabase:t,selectedTable:a}=S();return s.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[s.jsx("div",{className:"component pad-15",children:t?a?s.jsxs("p",{children:[e," / ",t," / ",a]}):s.jsxs("p",{children:[e," / ",t]}):s.jsx("p",{children:e})}),s.jsx(L,{database:t,table:a},t+"-"+a)]})};function R(){const{databaseType:e,loadDatabaseInfo:t}=S();return r.useEffect(()=>{t()},[]),e?s.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[s.jsx(O,{}),s.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:s.jsx(g,{})})]}):s.jsx("div",{children:s.jsx("p",{children:"Loading..."})})}export{R as A,_ as D};
