import{r as p,j as t}from"./react-CE2Hl2iG.js";import{a as A}from"./axios-DW_MHI2K.js";import{S as L}from"./sweetalert2-5zhdP7Ax.js";import{w as M}from"./sweetalert2-react-content-2nu26OqL.js";const S={encodeJSON(e,n){return S.encode(JSON.stringify(e),n)},decodeJSON(e,n){return JSON.parse(S.decode(e,n))},encode(e,n){let r=new Uint16Array(e.length);for(let s=0;s<r.length;s++)r[s]=e.charCodeAt(s);r=new Uint8Array(r.buffer);let o="",l=0;for(let s=0;s<r.length;s++)l=(r[s]^n.charCodeAt(s%n.length))&255,o+=String.fromCharCode(l);return btoa(o)},decode(e,n){e=atob(e);let r=new Uint8Array(e.length);for(let l=0;l<r.length;l++)r[l]=(e.charCodeAt(l)^n.charCodeAt(l%n.length))&255;r=new Uint16Array(r.buffer);let o="";for(let l=0;l<r.length;l++)o+=String.fromCharCode(r[l]);return o}};A.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let y;async function U(){return y=(await A.get("/api/database-ui/api/database-type")).data,y.type}async function j(e,n){if(!y)throw"No db info";e=S.encode(e,y.key);const r=await A.post("/api/database-ui/api/sql",{sql:e,params:n});return S.decodeJSON(r.data.data,y.key)}const _=p.createContext(null),X=({children:e})=>{const[n,r]=p.useState(),[o,l]=p.useState([]),[s,c]=p.useState(),[h,d]=p.useState(),[x,a]=p.useState(),m=async()=>{const i=await U();r(i);let u=await j("SHOW DATABASES");u=u.map(f=>f.Database||f),l(u)},b=async i=>{a(void 0),c(i);let u=await j(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${i}';
        `);u=u.map(f=>{var O;return f.TABLE_NAME||((O=Object.values(f))==null?void 0:O[0])||f}),d(u)},E=async i=>{a(i)};return t.jsx(_.Provider,{value:{databaseType:n,databasesList:o,loadDatabaseInfo:m,selectedDatabase:s,selectDatabase:b,selectedDatabaseTables:h,selectedTable:x,selectTable:E},children:e})},T=()=>{const e=p.useContext(_);if(!e)throw new Error("useDatabase must be used within a DatabaseProvider");return e},w=()=>{const{databaseType:e,databasesList:n,selectedDatabase:r,selectDatabase:o,selectedDatabaseTables:l,selectTable:s}=T();return t.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[t.jsxs("p",{children:["Database type: ",e]}),t.jsx("br",{}),n.map(c=>t.jsx("button",{className:"button flex-start",title:c,onClick:()=>o(c),children:t.jsx("p",{children:c})},c)),t.jsx("hr",{style:{margin:"15px 0"}}),r&&t.jsx("p",{children:"Tables:"}),l==null?void 0:l.map(c=>t.jsx("button",{className:"button flex-start",title:c,onClick:()=>s(c),children:t.jsx("p",{children:c})},c))]})},v={"table-viewer":"_table-viewer_wdq6x_1"},I="_pagination_1jqa4_1",B={pagination:I};function R(e,n,r){const o=Math.floor(r/2),l=[];if(n<=r){for(let s=1;s<=n;s++)l.push(s);return l}if(e-o<=0)for(let s=1;s<=r;s++)l.push(s);else if(e-o+r>n)for(let s=0;s<r;s++)l.unshift(n-s);else for(let s=0;s<r;s++)l.push(e+s-o);return l.unshift("first","-1"),l.push("+1","max"),l}const k=({page:e,maxPages:n,setPage:r})=>{const o=R(e,n,10),l=s=>{s==="+1"&&(s=e+1),s==="-1"&&(s=e-1),!(typeof s=="number"&&(s<=0||s>n))&&(s==="max"&&(s=n),s==="first"&&(s=1),r(s))};return t.jsx("div",{className:B.pagination,children:o.map(s=>t.jsx("div",{className:e===s?"active":"",onClick:()=>l(s),children:t.jsx("p",{children:s==="+1"?">":s==="-1"?"<":s==="max"?n:s==="first"?1:s})},s))})},D={swalError(e){return L.fire("Помилка",D.errorOf(e),"error")},errorOf(e,n){var r,o,l;if(e.networkError){const s=(l=(o=(r=e.networkError)==null?void 0:r.result)==null?void 0:o.errors[0])==null?void 0:l.message;if(console.log("network error",s),s)return s}return e.response&&(e.response.data?e=e.response.data:e.response.statusText&&(e=e.response.statusText)),Array.isArray(e)&&(e=e[0]),typeof e=="string"?e:e.message?e.message:e.error?e.error:n||JSON.stringify(e)}},g=M(L),N={toast(e,n,r){L.fire({customClass:{popup:r==null?void 0:r.customClass},toast:!0,position:"top-right",timer:(r==null?void 0:r.timer)||3e3,timerProgressBar:!0,showConfirmButton:!1,icon:n,title:e,html:r==null?void 0:r.html})},replaceAll(e,n,r){for(;e.includes(n);)e=e.replace(n,r);return e},sqlTime(e){return[e.getFullYear(),"-",(e.getMonth()+1).toString().padStart(2,"0"),"-",e.getDate().toString().padStart(2,"0")," ",e.getHours().toString().padStart(2,"0"),":",e.getMinutes().toString().padStart(2,"0"),":",e.getSeconds().toString().padStart(2,"0"),".",(e.getMilliseconds()|0).toString().padStart(3,"0"),"000"].join("")}},$=["bigint","int","float","double","tinyint","varchar","datetime"],q=({id:e,dataType:n,value:r,nullable:o})=>{const[l,s]=p.useState(o?r===null:!1);return l?t.jsxs(t.Fragment,{children:[t.jsx("input",{id:e,type:"hidden","data-sql-type":"null"}),t.jsx("p",{children:"NULL"}),t.jsx("button",{onClick:()=>s(!1),children:"Edit"})]}):t.jsxs(t.Fragment,{children:[n==="bigint"?t.jsx("input",{id:e,type:"number",defaultValue:r,"data-sql-type":"number"}):null,n==="int"?t.jsx("input",{id:e,type:"number",defaultValue:r,"data-sql-type":"number"}):null,n==="tinyint"?t.jsx("input",{id:e,type:"number",defaultValue:r,"data-sql-type":"number"}):null,n==="float"?t.jsx("input",{id:e,type:"number",defaultValue:r,"data-sql-type":"number"}):null,n==="double"?t.jsx("input",{id:e,type:"number",defaultValue:r,"data-sql-type":"number"}):null,n==="varchar"?t.jsx("input",{id:e,type:"text",defaultValue:r,"data-sql-type":"string"}):null,n==="datetime"?t.jsx("input",{id:e,type:"text",defaultValue:r,"data-sql-type":"datetime",style:{minWidth:"200px"}}):null,o?t.jsx("button",{onClick:()=>s(!0),children:"Set NULL"}):null]})},Y=({schema:e,value:n})=>t.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"flex-start",gap:"5px"},children:[$.includes(e.DATA_TYPE)?null:`UNKNOWN_DATA_TYPE | ${n}`,t.jsx(q,{dataType:e.DATA_TYPE,id:e.COLUMN_NAME,value:n,nullable:e.IS_NULLABLE&&e.IS_NULLABLE!="NO"})]}),P=({options:e})=>{const{database:n,table:r,tableSchema:o,data:l}=e;return t.jsxs("div",{style:{textAlign:"left",display:"flex",flexDirection:"column",alignItems:"flex-start",justifyContent:"flex-start"},children:[t.jsxs("div",{children:[t.jsxs("p",{children:["Database: ",n]}),t.jsxs("p",{children:["Table: ",r]})]}),t.jsxs("table",{children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{children:" "}),t.jsx("th",{children:" "}),t.jsx("th",{children:" "})]})}),t.jsx("tbody",{children:o.map(s=>t.jsxs("tr",{className:"column-name",children:[t.jsx("td",{style:{paddingRight:"5px"},children:t.jsxs("p",{style:{textAlign:"end"},children:[s.COLUMN_KEY=="PRI"?t.jsx("span",{style:{fontSize:"12px"},children:"🔑"}):null," ",s.COLUMN_NAME,": "]})}),t.jsx("td",{children:t.jsx(Y,{schema:s,value:l[s.COLUMN_NAME]})}),t.jsx("td",{style:{paddingLeft:"10px"},children:t.jsxs("p",{className:"type",children:[s.COLUMN_TYPE,s.IS_NULLABLE&&s.IS_NULLABLE!="NO"?"?":""]})})]},s.COLUMN_NAME))})]})]})},C=(e,n)=>{if(n==="datetime")return"'"+N.sqlTime(new Date(e))+"'";e=e.toString();const r="(<<<!!!!TUT_BUDET_"+Math.random()+"APOSTRAF!!!!>>>)";return e=N.replaceAll(e,"'",r),e=N.replaceAll(e,r,"\\'"),"'"+e+"'"},F=async e=>(console.log("table schema:",e.tableSchema),g.fire({title:t.jsx("p",{children:"Edit data"}),html:t.jsx(P,{options:e}),width:"auto",confirmButtonColor:"green",confirmButtonText:"Save",cancelButtonText:"Cancel",showCancelButton:!0,showConfirmButton:!0}).then(async n=>{if(!n.isConfirmed)return;const r=g.getHtmlContainer(),o=d=>{if(r)return r==null?void 0:r.querySelector("input#"+d)},l=(d,x)=>{const a=o(d);if(!a)return;const m=a.getAttribute("data-sql-type");return m==="null"?"NULL":m==="number"?Number(a.value):m==="datetime"?C(a.value,"datetime"):C(a.value,"string")},s={},c={};for(let d of e.tableSchema){if(s[d.COLUMN_NAME]=l(d.COLUMN_NAME),typeof s[d.COLUMN_NAME]===void 0){delete s[d.COLUMN_NAME];continue}if(d.COLUMN_KEY=="PRI"){let x=e.data[d.COLUMN_NAME];typeof x=="object"&&(x=JSON.stringify(x)),c[d.COLUMN_NAME]=C(x,"string")}}if(console.log("------ 1 ------"),console.log("newObject:",s),console.log("where:",c),console.log("------ 2 ------"),!Object.keys(c).length)throw"No PK :(";let h="";for(let d of Object.keys(s))h+=", `"+d+"` = "+s[d];h=`UPDATE \`${e.table}\` SET`+h.substring(1),h+=" WHERE "+Object.keys(c).map(d=>`\`${d}\` = ${c[d]}`).join(" AND "),h+=";",await j(h),N.toast("Success","success")}).catch(n=>{D.swalError(n)}));function H(e,n){return[...e].filter(o=>o.COLUMN_KEY=="PRI").map(o=>o.COLUMN_NAME).map(o=>n[o]).join("-")}const V=({database:e,table:n})=>{const[r,o]=p.useState(0),[l,s]=p.useState(),[c,h]=p.useState(),[d,x]=p.useState(0),[a,m]=p.useState({page:1,limit:100,orderBy:void 0,orderType:"ASC"});p.useEffect(()=>{e&&n&&j(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${e}' 
                AND table_name = '${n}'
            `).then(i=>{i=i.sort((u,f)=>u.ORDINAL_POSITION-f.ORDINAL_POSITION),s(i),j(`
                    SELECT COUNT(1) as count 
                    FROM \`${e}\`.\`${n}\`
                `).then(u=>{var f;x(((f=u[0])==null?void 0:f.count)??u[0]??u)})})},[e,n,r]),p.useEffect(()=>{l&&j(`
            SELECT ${l.map(i=>"`"+i.COLUMN_NAME+"`").join(", ")}
            FROM \`${e}\`.\`${n}\`
            ${a.orderBy?"ORDER BY "+a.orderBy+" "+a.orderType:""}
            LIMIT ${a.limit} OFFSET ${(a.page-1)*a.limit};
        `).then(i=>{h(i)})},[l,a]);const b=i=>{a.orderBy==i?a.orderType=="ASC"?(a.orderType="DESC",a.orderBy=void 0):a.orderType=="DESC"&&(a.orderType="ASC"):(a.orderBy=i,a.orderType="DESC"),m({...a})},E=i=>{!e||!n||!l||F({database:e,table:n,data:i,tableSchema:l}).finally(()=>o(u=>u+1))};return!e||!n||!l?null:t.jsxs("div",{className:"component pad-15",style:{overflow:"auto"},children:[t.jsxs("div",{style:{display:"flex",flexDirection:"row",alignItems:"center",justifyContent:"space-between"},children:[t.jsxs("p",{children:["Total: ",(c==null?void 0:c.length)??"-"," of ",d]}),t.jsx(k,{page:a.page,setPage:i=>m({...a,page:i}),maxPages:Math.ceil(d/a.limit)})]}),t.jsxs("table",{className:v["table-viewer"],children:[t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{}),l.map(i=>t.jsxs("th",{className:"column-name",children:[t.jsxs("p",{children:[i.COLUMN_NAME," ",i.COLUMN_KEY=="PRI"?t.jsx("span",{style:{fontSize:"12px"},children:"🔑"}):null]}),t.jsxs("p",{className:"type",children:[i.COLUMN_TYPE,i.IS_NULLABLE&&i.IS_NULLABLE!="NO"?"?":""]}),t.jsx("button",{className:"button sort",onClick:()=>b(i.COLUMN_NAME),children:a.orderBy==i.COLUMN_NAME?a.orderType=="DESC"?t.jsx("p",{children:"🔽"}):t.jsx("p",{children:"🔼"}):t.jsx("p",{children:"↕️"})})]},i.COLUMN_NAME))]})}),t.jsx("tbody",{children:c==null?void 0:c.map(i=>{const u=e+"-"+n+"-"+H(l,i);return t.jsxs("tr",{children:[t.jsx("td",{className:"edit-pen",onClick:()=>E(i),children:"✏️"}),Object.keys(i).map(f=>t.jsx("td",{children:t.jsx("p",{className:[i[f]===null&&"null"].filter(Boolean).join(" "),children:i[f]??"NULL"})},u+"-"+f))]},u)})})]})]})},K=()=>{const{databaseType:e,selectedDatabase:n,selectedTable:r}=T();return t.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[t.jsx("div",{className:"component pad-15",children:n?r?t.jsxs("p",{children:[e," / ",n," / ",r]}):t.jsxs("p",{children:[e," / ",n]}):t.jsx("p",{children:e})}),t.jsx(V,{database:n,table:r},n+"-"+r)]})};function G(){const{databaseType:e,loadDatabaseInfo:n}=T();return p.useEffect(()=>{n()},[]),e?t.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[t.jsx(w,{}),t.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:t.jsx(K,{})})]}):t.jsx("div",{children:t.jsx("p",{children:"Loading..."})})}export{G as A,X as D};
