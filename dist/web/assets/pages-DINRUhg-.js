import{r as i,j as a}from"./react-DuErVCKP.js";import{a as T}from"./axios-DW_MHI2K.js";const y={encodeJSON(e,t){return y.encode(JSON.stringify(e),t)},decodeJSON(e,t){return JSON.parse(y.decode(e,t))},encode(e,t){let s=new Uint16Array(e.length);for(let c=0;c<s.length;c++)s[c]=e.charCodeAt(c);s=new Uint8Array(s.buffer);let r="",n=0;for(let c=0;c<s.length;c++)n=(s[c]^t.charCodeAt(c%t.length))&255,r+=String.fromCharCode(n);return btoa(r)},decode(e,t){e=atob(e);let s=new Uint8Array(e.length);for(let n=0;n<s.length;n++)s[n]=(e.charCodeAt(n)^t.charCodeAt(n%t.length))&255;s=new Uint16Array(s.buffer);let r="";for(let n=0;n<s.length;n++)r+=String.fromCharCode(s[n]);return r}};T.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let f;async function D(){return f=(await T.get("/api/database-ui/api/database-type")).data,f.type}async function m(e,t){if(!f)throw"No db info";e=y.encode(e,f.key);const s=await T.post("/api/database-ui/api/sql",{sql:e,params:t});return y.decodeJSON(s.data.data,f.key)}const N=i.createContext(null),U=({children:e})=>{const[t,s]=i.useState(),[r,n]=i.useState([]),[c,l]=i.useState(),[j,u]=i.useState(),[C,o]=i.useState(),d=async()=>{const x=await D();s(x);let h=await m("SHOW DATABASES");h=h.map(b=>b.Database||b),n(h)},p=async x=>{o(void 0),l(x);let h=await m(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${x}';
        `);h=h.map(b=>{var E;return b.TABLE_NAME||((E=Object.values(b))==null?void 0:E[0])||b}),u(h)},A=async x=>{o(x)};return a.jsx(N.Provider,{value:{databaseType:t,databasesList:r,loadDatabaseInfo:d,selectedDatabase:c,selectDatabase:p,selectedDatabaseTables:j,selectedTable:C,selectTable:A},children:e})},S=()=>{const e=i.useContext(N);if(!e)throw new Error("useDatabase must be used within a DatabaseProvider");return e},O=()=>{const{databaseType:e,databasesList:t,selectedDatabase:s,selectDatabase:r,selectedDatabaseTables:n,selectTable:c}=S();return a.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[a.jsxs("p",{children:["Database type: ",e]}),a.jsx("br",{}),t.map(l=>a.jsx("button",{className:"button flex-start",title:l,onClick:()=>r(l),children:a.jsx("p",{children:l})},l)),a.jsx("hr",{style:{margin:"15px 0"}}),s&&a.jsx("p",{children:"Tables:"}),n==null?void 0:n.map(l=>a.jsx("button",{className:"button flex-start",title:l,onClick:()=>c(l),children:a.jsx("p",{children:l})},l))]})};function w(e,t){return[...e].filter(r=>r.COLUMN_KEY=="PRI").map(r=>r.COLUMN_NAME).map(r=>t[r]).join("-")}const g=({database:e,table:t})=>{const[s,r]=i.useState(),[n,c]=i.useState(),[l,j]=i.useState(0),[u,C]=i.useState({orderBy:void 0,orderType:"ASC"});return i.useEffect(()=>{e&&t&&m(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${e}' 
                AND table_name = '${t}'
            `).then(o=>{o=o.sort((d,p)=>d.ORDINAL_POSITION-p.ORDINAL_POSITION),r(o),m(`
                    SELECT COUNT(1) as count 
                    FROM \`${e}\`.\`${t}\`
                `).then(d=>{var p;j(((p=d[0])==null?void 0:p.count)||d[0]||d)})})},[e,t]),i.useEffect(()=>{s&&m(`
            SELECT ${s.map(o=>"`"+o.COLUMN_NAME+"`").join(", ")}
            FROM \`${e}\`.\`${t}\`
            ${u.orderBy?"ORDER BY "+u.orderBy+" "+u.orderType:""}
            LIMIT 500;
        `).then(o=>{c(o)})},[s,u]),!e||!t||!s?null:a.jsx("div",{className:"component pad-15",style:{overflow:"auto"},children:a.jsxs("table",{className:"test-table",children:[a.jsx("thead",{children:a.jsx("tr",{children:s.map(o=>a.jsx("th",{children:o.COLUMN_NAME},o.COLUMN_NAME))})}),a.jsx("tbody",{children:n==null?void 0:n.map(o=>{const d=e+"-"+t+"-"+w(s,o);return a.jsx("tr",{children:Object.keys(o).map(p=>a.jsx("td",{children:a.jsx("p",{className:[o[p]===null&&"null"].filter(Boolean).join(" "),children:o[p]??"NULL"})},d+"-"+p))},d)})})]})})},v=()=>{const{databaseType:e,selectedDatabase:t,selectedTable:s}=S();return a.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[a.jsx("div",{className:"component pad-15",children:t?s?a.jsxs("p",{children:[e," / ",t," / ",s]}):a.jsxs("p",{children:[e," / ",t]}):a.jsx("p",{children:e})}),a.jsx(g,{database:t,table:s},t+"-"+s)]})};function _(){const{databaseType:e,loadDatabaseInfo:t}=S();return i.useEffect(()=>{t()},[]),e?a.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[a.jsx(O,{}),a.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:a.jsx(v,{})})]}):a.jsx("div",{children:a.jsx("p",{children:"Loading..."})})}export{_ as A,U as D};
