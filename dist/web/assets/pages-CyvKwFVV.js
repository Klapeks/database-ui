import{r as o,j as n}from"./react-DuErVCKP.js";import{a as A}from"./axios-DW_MHI2K.js";const h={decodeArray(e,t){let s=Array(e.length);for(let a=0;a<e.length;a++)s[a]=h.decodeJSON(e[a],t);return s},encodeArray(e,t){let s=Array(e.length);for(let a=0;a<e.length;a++)s[a]=h.encodeJSON(e[a],t);return s},encodeJSON(e,t){return h.encode(JSON.stringify(e),t)},decodeJSON(e,t){return JSON.parse(h.decode(e,t))},encode(e,t){let s=Array(e.length);for(let a=0;a<e.length;a++)s[a]=(e.charCodeAt(a)^t.charCodeAt(a%t.length))&255;return btoa(String.fromCharCode(...s))},decode(e,t){e=atob(e);let s=Array(e.length);for(let a=0;a<e.length;a++)s[a]=(e.charCodeAt(a)^t.charCodeAt(a%t.length))&255;return String.fromCharCode(...s)}};A.create({baseURL:"/api",withCredentials:!1,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PUT, POST, DELETE, PATCH, HEAD, OPTIONS","Access-Control-Allow-Headers":"*",Accept:"application/json","Content-Type":"application/json","X-Control-Tokens":"client"}});let b;async function D(){return b=(await A.get("/api/database-ui/api/database-type")).data,b.type}async function f(e,t){if(!b)throw"No db info";e=h.encode(e,b.key);const s=await A.post("/api/database-ui/api/sql",{sql:e,params:t});return Array.isArray(s.data.data)?h.decodeArray(s.data.data,b.key):h.decodeJSON(s.data.data,b.key)}const C=o.createContext(null),_=({children:e})=>{const[t,s]=o.useState(),[a,d]=o.useState([]),[y,c]=o.useState(),[j,u]=o.useState(),[S,r]=o.useState(),l=async()=>{const x=await D();s(x);let p=await f("SHOW DATABASES");p=p.map(m=>m.Database||m),d(p)},i=async x=>{r(void 0),c(x);let p=await f(`
            SELECT table_name FROM information_schema.tables
            WHERE table_schema = '${x}';
        `);p=p.map(m=>{var N;return m.TABLE_NAME||((N=Object.values(m))==null?void 0:N[0])||m}),u(p)},E=async x=>{r(x)};return n.jsx(C.Provider,{value:{databaseType:t,databasesList:a,loadDatabaseInfo:l,selectedDatabase:y,selectDatabase:i,selectedDatabaseTables:j,selectedTable:S,selectTable:E},children:e})},T=()=>{const e=o.useContext(C);if(!e)throw new Error("useDatabase must be used within a DatabaseProvider");return e},O=()=>{const{databaseType:e,databasesList:t,selectedDatabase:s,selectDatabase:a,selectedDatabaseTables:d,selectTable:y}=T();return n.jsxs("div",{className:"component",style:{padding:"10px",borderRadius:0,minHeight:"100dvh",gap:"7px"},children:[n.jsxs("p",{children:["Database type: ",e]}),n.jsx("br",{}),t.map(c=>n.jsx("button",{className:"button flex-start",title:c,onClick:()=>a(c),children:n.jsx("p",{children:c})},c)),n.jsx("hr",{style:{margin:"15px 0"}}),s&&n.jsx("p",{children:"Tables:"}),d==null?void 0:d.map(c=>n.jsx("button",{className:"button flex-start",title:c,onClick:()=>y(c),children:n.jsx("p",{children:c})},c))]})};function g(e,t){return[...e].filter(a=>a.COLUMN_KEY=="PRI").map(a=>a.COLUMN_NAME).map(a=>t[a]).join("-")}const w=({database:e,table:t})=>{const[s,a]=o.useState(),[d,y]=o.useState(),[c,j]=o.useState(0),[u,S]=o.useState({orderBy:void 0,orderType:"ASC"});return o.useEffect(()=>{e&&t&&f(`
                SELECT * FROM information_schema.columns
                WHERE table_schema = '${e}' 
                AND table_name = '${t}'
            `).then(r=>{r=r.sort((l,i)=>l.ORDINAL_POSITION-i.ORDINAL_POSITION),a(r),f(`
                    SELECT COUNT(1) as count 
                    FROM \`${e}\`.\`${t}\`
                `).then(l=>{var i;j(((i=l[0])==null?void 0:i.count)||l[0]||l)})})},[e,t]),o.useEffect(()=>{s&&f(`
            SELECT ${s.map(r=>"`"+r.COLUMN_NAME+"`").join(", ")}
            FROM \`${e}\`.\`${t}\`
            ${u.orderBy?"ORDER BY "+u.orderBy+" "+u.orderType:""}
            LIMIT 500;
        `).then(r=>{y(r)})},[s,u]),!e||!t||!s?null:n.jsx("div",{className:"component pad-15",style:{overflow:"auto"},children:n.jsxs("table",{className:"test-table",children:[n.jsx("thead",{children:n.jsx("tr",{children:s.map(r=>n.jsx("th",{children:r.COLUMN_NAME},r.COLUMN_NAME))})}),n.jsx("tbody",{children:d==null?void 0:d.map(r=>{const l=e+"-"+t+"-"+g(s,r);return n.jsx("tr",{children:Object.keys(r).map(i=>n.jsx("td",{children:n.jsx("p",{className:[r[i]===null&&"null"].filter(Boolean).join(" "),children:r[i]??"NULL"})},l+"-"+i))},l)})})]})})},v=()=>{const{databaseType:e,selectedDatabase:t,selectedTable:s}=T();return n.jsxs("div",{className:"db-viewer-page",style:{display:"flex",flexDirection:"column",gap:"10px"},children:[n.jsx("div",{className:"component pad-15",children:t?s?n.jsxs("p",{children:[e," / ",t," / ",s]}):n.jsxs("p",{children:[e," / ",t]}):n.jsx("p",{children:e})}),n.jsx(w,{database:t,table:s},t+"-"+s)]})};function R(){const{databaseType:e,loadDatabaseInfo:t}=T();return o.useEffect(()=>{t()},[]),e?n.jsxs("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr"},children:[n.jsx(O,{}),n.jsx("div",{className:"page-view",style:{position:"sticky",top:0,overflowX:"hidden",overflowY:"auto",width:"100%",height:"100dvh",padding:"15px",display:"flex",flexDirection:"column"},children:n.jsx(v,{})})]}):n.jsx("div",{children:n.jsx("p",{children:"Loading..."})})}export{R as A,_ as D};
